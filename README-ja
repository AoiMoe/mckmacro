MCK 用マクロプロセッサ MCKMACRO

●コマンドライン
  mckmacro [-o outfile] [その他のオプション] [infile]

  -o outfile     出力ファイル名を指定します。省略された場合は標準出力です。
  -q             著作権表示の表示を抑止します。
  -Wfatal        エラーが発生したらすぐに停止します。
  -Werror        警告発生時時にも終了コードとしてEXIT_FAILUREを返します。
  -Wredefined    マクロの再定義を警告します。
  -Xline         Cプリプロセッサ風の#lineディレクティブを埋め込みます。
  -Xtrack-expand トラック展開を有効にします。
  infile         入力ファイル名を指定します。省略された場合は標準入力です。

●マクロの基礎
マクロの定義
  #\ で始まる行はマクロの定義です。たとえば次のようにするとマクロ TEST が
  定義されます。
  +----------------------------------------------------------------------+
  |#\TEST cdefgab>c                                                      |
  +----------------------------------------------------------------------+
  マクロ名として使えるのは英大文字と数字、アンダースコア(_)です。
    正しいマクロ名の例:      A   B   DRUM1   BEGIN_INTRO
    正しくないマクロ名の例:  a   b   DRUM-1  STR$
  マクロは同じ名前で何度でも定義し直すことができます。

マクロの展開
  任意の位置で \MACRONAME とすることでそこにマクロの内容が展開されます。
  たとえば、
  +----------------------------------------------------------------------+
  |#\TEST cdefgab>c                                                      |
  |A t150\TEST                                                           |
  +----------------------------------------------------------------------+
  は
  +----------------------------------------------------------------------+
  |                                                                      |
  |A t150cdefgab>c                                                       |
  +----------------------------------------------------------------------+
  と展開されます。マクロを再定義した場合の例は次のようになります:
  +----------------------------------------------------------------------+
  |#\TEST cdefgab>c                                                      |
  |A t150\TEST                                                           |
  |#\TEST c<bagfedc                                                      |
  |B t150\TEST                                                           |
  +----------------------------------------------------------------------+
  ↓
  +----------------------------------------------------------------------+
  |                                                                      |
  |A t150cdefgab>c                                                       |
  |                                                                      |
  |B t150c<bagfedc                                                       |
  +----------------------------------------------------------------------+


●空白の扱い
  次のようなルールがあります:
  1. マクロ展開の直後にある最初の空白文字は削除される。
  2. マクロは展開されると末尾に空白が追加される。ただし、定義時に "" で
     囲まれたマクロの展開時には追加されない。
  3. マクロ定義は空行になる。
  4. マクロ定義のマクロ名と展開文字列との間にある空白はいくつあっても
     無視される。ただし、最低 1 つは必要。

  次の例を見たほうが早いでしょう:
  +----------------------------------------------------------------------+
  |#\TEST1     c                                                         |
  |#\TEST2     "c"                                                       |
  |#\TEST3     EPOF                                                      |
  |#\TEST4     "EPOF"                                                    |
  |A \TEST1b                                                             |
  |B \TEST2b                                                             |
  |C \TEST1 4                                                            |
  |D \TEST2 4                                                            |
  |E \TEST2  4                                                           |
  |F \TEST3 MPOF                                                         |
  |G \TEST4 MPOF                                                         |
  +----------------------------------------------------------------------+
  これを展開すると以下のようになります:
  +----------------------------------------------------------------------+
  |                                                                      |
  |                                                                      |
  |A c b                                                                 |
  |B cb                                                                  |
  |C c 4                                                                 |
  |D c4                                                                  |
  |E c 4                                                                 |
  |F EPOF MPOF                                                           |
  |G EPOFMPOF                                                            |
  +----------------------------------------------------------------------+
  ルール 1 がないとトラック D のような展開を行うことができません。MCK では
  音符と音長の間に空白を入れることが許されないため、これができないと困ります。
  ルール 2 はトラック G のようなエラーを防ぐためのものです。デフォルトでは
  空白を入れるようにしていますが、トラック D のケースを扱えるようにするために、
  "" を導入しています。
  ルール 3 は、極力エラーメッセージの行がズレないようにするための措置です。

  ルール 2 が直感的ではないように見えるかもしれませんが、これは安全側に
  振ってあるのです。次の例を見てみましょう:
  +----------------------------------------------------------------------+
  |#\TEST "c"                                                            |
  |#\TEST1 "b"                                                           |
  |#\TEST2 \TEST                                                         |
  |#\TEST3 "\TEST"                                                       |
  |A \TEST2 1                                                            |
  |B \TEST3 1                                                            |
  +----------------------------------------------------------------------+
  マクロは再帰的に展開されるので、これはまず次のような段階を経て(空行は省略):
  +----------------------------------------------------------------------+
  |A \TEST 1                                                             |
  |B \TEST1                                                              |
  +----------------------------------------------------------------------+
  最終的に次のように展開されます(空行は省略):
  +----------------------------------------------------------------------+
  |A c1                                                                  |
  |B b                                                                   |
  +----------------------------------------------------------------------+
  デフォルトでトラック B のような展開が行われてしまうと、見つけにくい間違いに
  なることがあります。一方、\TEST の "" を忘れると次のように展開されます:
  +----------------------------------------------------------------------+
  |A c 1                                                                 |
  +----------------------------------------------------------------------+
  これはエラーになりますが、エラーになるだけマシというものです。

●スコープ
  MCKMACRO には名前空間の概念があります。マクロ名の前に :スコープ名: という
  形のスコープ指定子を付ける事によってスコープ名を指定することができます。
  スコープ名には通常のマクロ名と同じ文字種のほかに英小文字も使えます。また、
  特殊なスコープとしてグローバルスコープ :: があります。
  例を見てみましょう:
  +----------------------------------------------------------------------+
  |#\TEST     cde                                                        |
  |#\:c:TEST  fga                                                        |
  |A \TEST                                                               |
  |B \::TEST                                                             |
  |C \:c:TEST                                                            |
  +----------------------------------------------------------------------+
  これは次のように展開されます:
  +----------------------------------------------------------------------+
  |#\TEST     cde                                                        |
  |#\:a:TEST  fga                                                        |
  |A cde                                                                 |
  |B cde                                                                 |
  |C fga                                                                 |
  +----------------------------------------------------------------------+
  このように、同じ名前で複数のマクロを定義することができます。次に説明する
  スコープ設定を使うと、トラックごとに一文字マクロを使えて便利です。

●スコープ設定
  #: で始まる行はスコープ設定です。これは現在のデフォルトのスコープを切り
  替えるものです。スコープ指定子のないマクロ定義やマクロ展開は、この
  デフォルトスコープの空間にあるマクロを参照しに行き、見つからなかった
  場合にはグローバルスコープを参照しに行きます。#: のみの行ではスコープを
  グローバルスコープへと戻します。
  例を見てみましょう:
  +----------------------------------------------------------------------+
  |#:                                                                    |
  |#\T  cde                                                              |
  |#:A                                                                   |
  |#\T  fga                                                              |
  |#:B                                                                   |
  |#\T b>cd                                                              |
  |                                                                      |
  |#:A                                                                   |
  |A \T                                                                  |
  |#:B                                                                   |
  |B \T                                                                  |
  |#:C                                                                   |
  |C \T                                                                  |
  +----------------------------------------------------------------------+
  これは次のように展開されます(空行は省略):
  +----------------------------------------------------------------------+
  |A fga                                                                 |
  |B b>cd                                                                |
  |C cde                                                                 |
  +----------------------------------------------------------------------+
  トラック A はスコープ A のマクロ T を、トラック B はスコープ B の
  マクロ T をそれぞれ参照していますが、トラック C ではスコープ C に
  マクロ T が定義されていないためグローバルスコープのマクロ T を
  参照しています。

●自動スコープ設定
  #:+ と #:- で、自動スコープ設定のオンオフを切り替えられます。
  自動スコープ設定がオンになっていると、行の先頭文字が英字の場合に、
  デフォルトスコープ名をその文字に切り替えます。例を見てみましょう:
  +----------------------------------------------------------------------+
  |#\:A:T fga                                                            |
  |#\:B:T b>cd                                                           |
  |#:+                                                                   |
  |A \T                                                                  |
  |B \T                                                                  |
  +----------------------------------------------------------------------+
  これは次のように展開されます(空行は省略):
  +----------------------------------------------------------------------+
  |A fga                                                                 |
  |B b>cd                                                                |
  +----------------------------------------------------------------------+
  この方法によって切り替わったデフォルトスコープは、以降の行にも影響を
  与えます。たとえば、次のマクロ定義はスコープ A のマクロ TEST を定義して
  いることになります:
  +----------------------------------------------------------------------+
  |#:+                                                                   |
  |A cde                                                                 |
  |#\TEST fga                                                            |
  +----------------------------------------------------------------------+
  なお、自動スコープ指定はデフォルトではオフになっています。

●トラック展開
  コマンドラインオプション-Xtrack-expandを指定すると、トラック展開が有効に
  なります:
  +----------------------------------------------------------------------+
  |ABC x                                                                 |
  +----------------------------------------------------------------------+
  これは次のように展開されます:
  +----------------------------------------------------------------------+
  |A x                                                                   |
  |B x                                                                   |
  |C x                                                                   |
  +----------------------------------------------------------------------+
  自動スコープ機能と組み合わせれば便利かもしれません:
  +----------------------------------------------------------------------+
  |#:+                                                                   |
  |#\:A:X  @0c                                                           |
  |#\:B:X  @1c                                                           |
  |#\:C:X    c                                                           |
  |ABC \X                                                                |
  +----------------------------------------------------------------------+
  これは次のように展開されます(空行は省略):
  +----------------------------------------------------------------------+
  |A @0c                                                                 |
  |B @1c                                                                 |
  |C c                                                                   |
  +----------------------------------------------------------------------+
  なお、この機能はコマンドラインオプション以外にも、#+track-expandで有効に、
  #-track-expandで無効にすることができます:
  +----------------------------------------------------------------------+
  |#+trexpand
  |ABC x                                                                 |
  |#-trexpand
  |ABC x                                                                 |
  +----------------------------------------------------------------------+
  これは次のように展開されます:
  +----------------------------------------------------------------------+
  |                                                                      |
  |A x                                                                   |
  |B x                                                                   |
  |C x                                                                   |
  |                                                                      |
  |ABC x                                                                 |
  +----------------------------------------------------------------------+

●その他
  #! を使うとマクロを消去することができます:
  +----------------------------------------------------------------------+
  |#\TEST cde                                                            |
  |#\:A:TEST fga                                                         |
  |#:+                                                                   |
  |A \TEST                                                               |
  |#!:A:TEST                                                             |
  |A \TEST                                                               |
  +----------------------------------------------------------------------+
  これは次のように展開されます(空行は省略):
  +----------------------------------------------------------------------+
  |A fga                                                                 |
  |A cde                                                                 |
  +----------------------------------------------------------------------+

  #< でファイルのインクルードができます:
  +----------------------------------------------------------------------+
  |#< test.mml                                                           |
  +----------------------------------------------------------------------+

●著作権
  著作権は塩崎拓也 <tshiozak@bsdclub.org> が有しています。
  使用条件は二条項 BSD ライセンスですので、次の著作権表示を配布物の一部に
  含めれば、バイナリもソースも商用非商用限らず自由に再利用可能です:

   Copyright (c)2006-2015 Takuya SHIOZAKI,
   All rights reserved.

   Redistribution and use in source and binary forms, with or without
   modification, are permitted provided that the following conditions
   are met:
   1. Redistributions of source code must retain the above copyright
      notice, this list of conditions and the following disclaimer.
   2. Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the distribution.

   THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
   ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
   FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
   DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
   OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
   HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
   LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
   OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
   SUCH DAMAGE.

●変更履歴
  version 20150405.00
    - バージョン番号のスキームを変えた。
    - ビルド環境をMinGWに変えた。
    - C++11前提にした。
    - -Wfatal, -Werror, -Wredefined, -Xline を追加した。
    - エラーが出ても停止せずにひとまず最後まで処理を続行するようにした。
